## 栈介绍

栈是一种后进先出（LIFO）的数据结构，主要操作有 push 和 pop，两种操作都位于栈顶。程序的栈是从高地址向低地址增长的。

### 函数调用栈

程序的执行可看作连续的函数调用，函数执行完毕时，程序回到调用指令的下一条指令处继续执行。函数调用过程通常使用堆栈实现，每个用户态进程对应一个调用栈结构。编译器使用堆栈传递函数、保存返回地址、保存函数上下文以备恢复以及存储本地局部变量。

#### 寄存器

x86 下寄存器使用：

- EIP 指令寄存器，自增或被 jmp, call, ret 等指令改变。
- ESP 堆栈指针寄存器，存访执行函数对应栈的栈顶地址。
- EBP 栈帧基址指针寄存器，存访执行函数对应栈帧的栈底地址，用于访问栈中的局部变量和参数。

EAX, EDX, ECX 为主调函数保存寄存器，主调函数希望保持这些寄存器的值，则必须在调用前将其保存在栈中。

EBX, ESI, EDI 为被调函数保存寄存器，被调函数覆盖这些寄存器时，必须先将寄存器原值压栈保存，并在函数返回前从栈中恢复原值，因为主调函数也可能使用这些寄存器。

被调函数必须保持 EBP 和 ESP，并在函数返回后将其恢复到调用前的值，即恢复主调函数栈帧。
  
#### 栈帧结构

同一时刻，堆栈会有多个函数的信息。每个未完成运行的函数占用一个独立的连续区域，称为栈帧。栈帧是堆栈的逻辑片段，当调用函数时逻辑栈帧被压入堆栈，当函数返回时被从堆栈中弹出。栈帧中存访函数参数、局部变量及恢复前一栈帧所需的数据。

编译器将控制权移交函数本身之前，插入特定代码将函数参数压入栈帧中，并分配足够的内存空间用于存放函数中的局部变量。栈帧使递归调用变为可能。

栈帧的边界由 EBP 和 ESP 界定，分别指向高地址栈底和低地址栈顶。EBP 在当前栈帧内位置固定，函数大部分数据的访问基于 EBP 进行。
