---
Title: 基于路径切割与重组的二进制代码自动生成系统
Title_en: Binary Code Auto-generating System based on Path Cutting and Rebuilding
author: 秦浩翔
No.: 1613573
Grade: 2016
Major: 信息安全
Faculty: 信息安全
College: 网络空间安全学院
Mentor: 王志副教授
---

# 基于路径切割与重组的二进制代码自动生成系统

> Binary Code Auto-generating System based on Path Cutting and Rebuilding

## 摘要

随着互联网技术的普及和发展，计算机与人们的工作和生活之间的联系越来越紧密。人们在享受技术带来的极大便利的同时，也不可避免地要面对随之而来的诸多安全问题。互联网环境中存在大量恶意软件，严重威胁了计算机系统的安全。近年来，恶意软件数量高速增长，传统的人工分析面临严峻挑战，这使得运用机器学习技术的恶意软件分析技术成为研究热点。由于大部分恶意软件基于现有的恶意软件开发，恶意软件呈家族性分布，因此恶意软件的作者分析成为溯源过程的重要一环。现有的基于监督学习的作者识别技术研究已取得一定的进展，实现了较高的准确率。本文以攻击者的角度看待这一问题，提出使用代码混淆手段对抗软件作者识别技术。

本文通过对现有二进制作者归属技术的分析和研究，设计并实现了基于代码混淆的对抗作者识别的二进制代码自动生成系统。系统使用代码混淆技术，着重对作者识别技术所依赖的二进制程序特征进行混淆处理，以降低作者识别成功率。该系统为对抗作者识别技术提供了自动化方案，也为设计更安全的作者识别系统提供了对抗性样例。

## Abstract

With the popularity and development of Internet technology, the connection between computers and people's work and life is getting closer. While people enjoy the great convenience brought by technology, they also inevitably face many ensuing security issues. There is a large amount of malware in the Internet environment, which seriously threatens the security of computer systems. In recent years, the number of malware has increased rapidly, and traditional manual analysis faced severe challenges, which has made malware analysis techniques using machine learning a hot topic of research. Since most malware is based on existing malware, and the malware is distributed in a family, malware authorship attribution becomes an important part of the analysis process. Existing research on authorship attribution based on supervised learning has made some progress and achieved high accuracy. This thesis looks at this problem from an attacker’s perspective and proposes to use binary code obfuscation to combat software authorship attribution techniques.

Based on the analysis and research of the existing binary authorship attribution technology, this paper designs and implements an automatic binary code generation system against authorship attribution based on code obfuscation. The system uses code obfuscation technology and focuses on obfuscation processing of the binary program features that the authorship attribution relies on to reduce the accuracy. This system provides an automated solution against authorship attribution, and also provides adversarial examples for designing a more secure authorship identification system.

## 引言

1. 研究背景

    > [AV-Test 恶意软件统计数据](https://www.av-test.org/en/statistics/malware/)
    >
    > 关键点：
    >
    > 1. 每天超过 35 万个新的恶意程序。
    > 2. 恶意软件样本数突破十亿。
    > 3. MacOS 和 IoT 的恶意软件数量急速上升，Windows 仍是重点。


2. 相关研究
   1. 作者身份识别
   2. 代码混淆
3. 创新点，目前准备将现有的代码混淆技术应用到对抗二进制作者身份识别中。
4. 介绍各个章节内容。

### 研究背景

随着互联网技术的飞速发展，人们在享受其带来的极大便利的同时，不可避免地要面对随之而来的安全问题。互联网中存在大量的恶意软件，严重威胁了人们的隐私安全和财产安全。根据权威机构 AV-Test 发布的统计数据[^1]，平均每天新增 37 万多个恶意软件样本，总数已突破 10 亿，且仍呈现高速增长趋势。传统的人工分析依赖于安全人员的技术水平和恶意软件的复杂程度，难以应对大量的恶意软件分析任务。为实现高效准确的恶意软件分析，基于机器学习的恶意软件分析技术成为研究热点。

通过数据分析发现，很多恶意软件都是从现有的恶意代码更新演变而来，或者属于同一恶意软件家族，这些代码都有一定的相似性。特别由同一攻击者开发的恶意软件存在更多的代码复用，相似度更高。针对大量存在的恶意软件变体和恶意软件家族现象，如果知道恶意软件所属家族将有助于进一步的分析和防御。现有的基于监督学习的二进制程序作者识别技术可用于恶意软件检测，从大量样本中提取出恶意软件特征，训练出识别恶意软件作者的分类器，能够识别出同一家族或同一攻击者开发的恶意软件。

然而现有的作者识别技术依赖于二进制文件中易被修改的静态特征，包括字节流、汇编指令以及函数调用图和控制流程图等特征，这些特征在一定程度上可以表现程序之间的相似性。本文提出使用代码混淆技术处理原二进制文件，破坏用于作者识别的静态特征，降低识别准确率。代码混淆是热门的软件保护技术，该技术通过对原程序进行复杂化处理，加大逆向分析的难度，可以很大程度上抵抗静态分析。代码混淆算法具有多样性和灵活性，可以根据对强度和性能的不同要求选择合适的算法。

### 相关研究概述

#### 程序作者身份归属

作者归属即确定作品的作者，其核心思想是作者在创作过程中赋予作品以个人风格。虽然这种归因研究历来集中在文学文献领域，而计算机程序同样作为创造性过程的产物，其中必然包含作者的编程风格，这为程序作者身份归属提供了实现的可能。程序作者身份归属的任务是确定程序作者，在剽窃检测和数字取证等领域有重要应用。最初的程序作者归属研究仅限于源代码层面，依赖于诸如如缩进和变量命名等程序源代码的文本性质实现作者识别。针对源代码的作者归属技术实现了较高的成功率。

然而，在许多领域，如商业软件或恶意软件的分析，往往无法获取程序的源代码，而源代码文本的表面特性在编译过程中被删除。Rosenblum 等人首次提出假设，认为程序员风格在编译过程中得以保留，并通过实验证明了假设的合理性。使用监督学习技术，通过预定义模板捕获二进制程序的局部和全局特征，并以大量已知作者的二进制程序作为训练集，根据训练阶段中特征与作者身份的关联性将特征排序，选取关联性大的特征用于后续的作者归属的依据。初步实现了从一组候选人中识别程序作者的分类技术和基于二进制程序相似性的聚类算法，证明了二进制程序作者识别技术的可行性。

Caliskan 等人在前人的基础上提出将源代码作者归属中常用的抽象语法树特征应用到二进制层面，通过反汇编和反编译工具将程序转换为高级程序语言代码，构建抽象语法树。使用基于相关性的特征选择算法，评估特征的个体预测能力与冗余程序，筛选出用于作者身份识别和聚类的特征，实现了较高的准确率。

Saed 等人研究发现，根据训练阶段作者身份相关性排序的特征选择方法并不能真正选择与编程风格相关的特征，尽管排名靠前的特征对不同作者展现出良好的独特性，但其中很多特征如编译器生成的包含随机（因此是唯一的）数字的标识符或函数名，这些显然不能反映作者编程风格。因此 Saed 提出了分层的作者归属技术，包括过滤无关代码的预处理层、基于语法特征归因的代码分析程、基于语义特征归因的寄存器流分析层，以实现有效的作者身份识别。

#### 代码混淆

在针对软件的 MATE（Man At The End）攻击中，攻击者完全掌握软件的运行环境和运行状态，通过对运行状态进行任意的查看、修改，通过逆向工程对软件进行分析、测试，可以获取程序的执行逻辑、算法和数据，严重威胁了软件开发者的知识产权。代码混淆技术是对抗逆向工程的软件保护技术，在保持原程序功能的情况下通过复杂的变换增加程序的复杂程度，使攻击者难以分析和理解程序执行的流程和原理。当前的代码混淆技术主要针对反汇编和反编译技术，涉及源代码和二进制代码层面的混淆。

Collberg 等人提出了混淆转换的定义、混淆算法的分类及其有效性评估。根据 Collberg 的分类，混淆转换可分为词法结构混淆、控制流混淆、数据混淆以及针对特定反混淆器的混淆。词法结构混淆又称布局混淆，是指删除或修改程序源代码或中间代码中的辅助信息，通常包括删除调试信息、删除注释和混淆标识符等方法。布局混淆不改变程序的执行过程，保护能力较弱。控制流混淆的主要目的是增加程序控制流的复杂程度，通过聚合和分割变换、次序变换和计算混淆等方法实现。随着符号执行技术的兴起，控制流混淆成为代码混淆领域的研究热点。数据混淆是指对程序中的数据或数据结构变换，增加代码的复杂度，常用变量存储和编码、数据结构聚合和分割等方法。

### 研究内容

本文通过研究现有的作者身份归属技术，设计有效的代码混淆算法对二进制程序进行混淆变换，以达到干扰静态分析、对抗程序作者识别的目的。

### 本文结构

本文一共分为五章，文章组织结构如下：

第一章是引言，介绍了本文的研究背景、相关研究概述及研究内容。

第二章主要介绍论文相关技术，包括程序作者识别技术和代码混淆相关技术。

第三章是本文的核心内容，提出了针对程序作者归属的代码混淆方法，介绍了系统的设计和实现过程。

第四章主要是对系统进行测试，通过代码混淆技术对作者识别准确率的影响评估，分析了使用代码混淆技术对抗作者身份归属研究的可行性。

第五章对本文进行了总结与展望。

## 相关研究

1. PE 文件结构

   dos 头、PE 头、区块表、区块

   导出表、导入表、重定位表

2. 二进制作者识别，读的几篇文章，介绍一下识别的思路。

   特征提取，特征选择

3. 代码混淆，分类，主要是路径分支。

   概念、分类

### PE 文件结构

Windows 是目前使用最广泛的操作系统，超过一半的恶意软件都针对 Windows 系统开发。本节介绍了 Windows 下可执行程序的格式。

PE 是 Portable Executable File Format 的缩写，意为可移植的可执行文件格式。PE 格式是目前 Windows 平台上主流的可执行文件格式，常见的 EXE、DLL 都是 PE 文件。PE 文件总体上由几个部分组成，依次为 DOS 头部、PE 文件头、区块表、数据块。

PE 文件内容被分割成不同的区块，区块中包含代码或数据，每个块都有其在内存中的属性。PE 文件通常需要加载到内存中才能执行，因此也称为映像文件。Windows 加载器（即 PE 装载器）遍历 PE 文件并决定文件的哪一部分被映射到内存地址中。

PE 文件的开头是 MS-DOS 头部，主要用于处理系统兼容性问题，在 DOS 环境下会输出“This program cannot be run in DOS mode.” 的错误提示。PE 装载器会根据 DOS 头部最后一个字段跳转到 PE 文件头的起始位置。

PE 文件头包括签名、标准文件头和可选头。PE 签名是固定的 4 字节大小的 “PE\\0\\0” 字符串，加载器根据签名判断文件是一个 PE 格式文件。标准文件头中保存了 PE 文件的基本信息，包括文件区块数量、可选头大小和文件属性等。标准头的信息不足以定义 PE 文件属性，可选头包含了程序入口点、装载基址、映像文件大小以及数据目录表信息。其中数据目录表中保存了程序的重要信息，如导入表、导出表、重定位表等。

紧跟在可选头之后的是区块表，是 IMAGE_SECTION_HEADER 结构体的数组，每项对应着区块的信息。区块表指定了区块名、物理地址、相对地址和区块属性等信息，常见的区块有 .text 代码段、.data 可读写数据段、.rdata 只读数据段和 .reloc 重定位块。这些信息对程序的加载和执行极为重要，对 PE 文件进行修改时应保证 PE 文件头和区块信息的一致性，以避免破坏可执行文件功能。

### 程序作者身份归属

作者归属即确定作品的作者，其核心思想是作者在创作过程中赋予作品以个人风格。这种作者归因研究历来集中于文学文献等领域，而计算机程序同样属于创造性过程的产物，其中也必然包含作者的个人风格，这就为程序作者身份归属提供了现实基础。程序作者识别的任务是确定程序作者，这在软件剽窃检测和恶意软件溯源等领域有重要应用。早期的程序作者归属研究仅限于源代码层面，依赖于源代码的文本特性，如缩进和变量命名，以及源代码的语法特征，如基于源码的构建抽象语法树，实现了较高的成功率。

然而，在许多领域，如恶意软件的分析，往往无法获取程序的源代码，源代码的大量文本特征在编译过程中被删除，这种基于源码的作者归因技术无法直接应用到二进制文件的分析中。实现基于二进制程序的作者归属需要设计新的方法。Rosenblum 等人首次提出假设，认为程序作者的编程风格在编译过程中得以保留。为了验证这一假设，他们设计了一种机器学习算法，首先定义大量的简单候选特征，包括程序指令序列、控制流、库函数调用等特征，然后根据训练数据筛选能够反映程序作者风格的特征。二进制层面的作者归属很难确定哪些特征能够反映程序作者风格，这种做法巧妙地避免了这一问题。他们将这种技术应用到两个具体的二进制代码作者归属问题：从一组候选人中识别程序的作者，以及通过特征相似性对未知作者的程序分组，分别开发了基于二进制代码特征的分类和聚类模型。特征提取后，将大量已知作者的程序样本划分为训练集和验证机，一部分用于训练分类器，一部分用于评估精度，通过交叉验证选择更优的特征子集。最后根据训练中特征与程序作者身份的关联进行排序，排名靠前的特征更能反映程序作者风格。监督学习中获取的作者身份归属知识可以转移到程序聚类，提升聚类的准确率。该实验证明了二进制程序作者识别的可行性，为之后的研究奠定了基础。

Caliskan 等人在 Rosenblum 的基础上，提出使用二进制程序反汇编源码的语法特征提升作者识别的准确率。源代码层面的作者归属研究已经证明抽象语法树等语法特征对作者身份归属有效。因此 Caliskan 对二进制程序的反汇编结果构建抽象语法树，并行地使用多个反汇编与反编译工具，生成不同的程序员编码风格表示形式，提升作者识别的准确率。使用随机森林的机器学习算法，有效地结合多种特征而避免过度拟合。Caliskan 等人使用来自 Google Code Jam 的数据集训练和测试，100 个程序员每人 9 个程序，识别准确率高达 95%，在候选人多而样本程序少的情况下同样保证了 top-n 的高准确率，进一步证明了编程风格经过编译过程保留在二进制文件中。

以上两个二进制层面的作者归属研究都在特征选择是根据训练阶段与作者身份的关联性排序，选择相关性高的特征。Saed 等人提出，根据特征相关性排序的选择出的特征并不都与作者编程风格相关。排名靠前的对于不同的作者表现出明显的差距，并不意味着它们成功捕获了作者的编程风格，如编译器生成的包含随机（因此是唯一的）数字的标识符或函数名，显然不能反映编程风格。即特征的唯一性不等同于作者风格。同时，Rosenblum 等人使用的特征模板如指令序列，往往无法体现程序语义，可能会误导识别结果。为解决这些问题，Saed 等人提出了一种分层的作者归属框架，结合了过滤无关代码的预处理层、基于语法特征归因的代码分析层以及基于语义归因的寄存器流分析层。

预处理层负责区分用户代码和库函数代码。使用 IDA Pro 识别标准库函数，以及由编译器生成的代码，如静态链接的库函数和初始化函数。使用基于签名匹配的技术识别二进制程序中的库函数，首先解析函数库，提取函数原型、数据结构以及类型信息，有助于识别函数调用约定和参数。基于字节序列、函数大小以及函数视线中的特征如常量、字符串、导入和调用的函数等为库的导出函数创建签名。然后将签名应用到二进制程序的反汇编代码的函数列表中，进行签名匹配，标记库函数调用。将识别出的库函数从函数列表中移除，剩下的用于代码用于进一步分析。

代码分析层的主要挑战是从二进制重建源代码层面的语法，创建一个语法模板库（Syntax Template Library），将 C++ 关键字匹配到汇编指令序列。如 for 循环语句往往对应着 cmp-jg-xor-jmp 的汇编指令序列，if 语句对应 mov-cmp-jnz-mov-jmp 的序列。通过以基本块为单位的基于哈希的精确匹配和构造特征向量基于相似性函数的非精确匹配，为每个作者建立语法资料，包括语义类型、创建和调用函数的风格以及程序复杂度。这些数据会用于作者归属的分类和聚类。寄存器流分析层用于捕获基于代码语义的编程风格，即寄存器操作方式。在二进制文件的反汇编结果中寻找比较指令，根据寄存器的变化构建对应的寄存器流图。

然而，现有的基于监督学习的二进制代码作者身份识别技术都基于已被修改的静态特征。Meng 等人从攻击者的角度研究二进制代码作者识别问题，提出了针对现有的监督学习作者识别分类器的攻击框架。主要研究两种攻击：非针对性攻击，目的在于导致对任何不正确作者的错误预测，以及针对性攻击，目的是导致对特定不正确作者的错误预测。实验表明，非针对性攻击的成功率为 96%，二进制文件中的作者风格信息经处理后被破坏。而针对性攻击的平均成功率为 46%，这表明从二进制层面模仿作者编程风格存在一定可行性但显然更加困难。这种基于对抗机器学习的攻击要求攻击者对目标分类器足够了解，攻击设计应基于目标分类器所使用的特征集、特征提取工具以及机器学习算法。

### 代码混淆

代码混淆定义、分类、评估指标

代码混淆是一种对抗逆向工程的软件保护技术，在保持程序原功能的情况下通过复杂的变换增加程序的复杂程度，使程序难以分析和理解。现有的二进制程序静态分析都是通过反汇编和反编译工具将程序转换成汇编代码和高级语言代码，因此代码混淆的主要研究内容就是抵抗反汇编和反编译技术。

Collberg 等人最先给出了代码的定义：

原程序 P 经过一个变换 T 后变成目标程序 P’，满足以下条件的变换成为程序 P 到目标程序 P’ 的一个混淆变换：

1. 如果某输入导致原程序 P 出现错误终止或无法正常终止，目标程序 P' 可以终止或不终止；
2. 否则，目标程序 P' 必须终止，且 P' 的输出结果必须和原程序 P 的输出结果相同。

#### 代码混淆的分类

Collberg 根据混淆变换的对象不同将混淆分为四类：布局混淆、控制流混淆、数据混淆和预防性混淆。

布局混淆又称词法结构混淆，是指删除或修改中间代码或源代码中的有用信息。常用的布局混淆手段有删除注释和调试信息以及混淆变量名、函数名等。布局混淆是最简单的混淆方法，常用于源代码的混淆。由于软件攻击者无法直接获取软件的源代码，因此布局混淆的保护能力较弱，主要用于 Java 字节码的混淆。

数据混淆是指变换程序中数据和数据结构，增加代码复杂度。主要有存储编码、聚合和次序的变换。存储编码变换是通过混淆程序变量存储和编码方式，使攻击者难以分析变量的用途。聚合变换是指将多个数据聚合称新的数据结构，以隐藏原始的数据格式。

控制流混淆是指在不改变程序原功能的情况下，隐藏或改变程序的控制流，增加软件中控制流的复杂程度。根据对控制流的修改方式不同可分为控制聚合、次序混淆和计算混淆三种。控制聚合是将逻辑上相关的运算拆分开，或将不相关的运算聚集到一起，具体实现方法有函数内嵌、函数克隆和循环变换等。次序混淆是基于表达式、基本块或方法的局部性原理，将于一相关的代码随机分散到不同的位置，增加代码的上下文无关性，实现方法主要是对语句块和语句块内部语句进行重排。计算混淆是指引入混淆计算代码来隐藏控制流，具体实现方法包括引入不透明谓词等。

不透明谓词是控制流混淆中的重要技术，Collberg 把不透明谓词定义为一个布尔表达式，该表达式的值对于混淆这是可知的，对于其他人是难以获知的。引入不透明谓词不会改变程序的实际执行顺序，只是使控制流更加复杂难以分析。不透明谓词适用于无分支代码的混淆，另一种针对无条件跳转指令的混淆技术是控制流平坦化，经过控制流平展变换后，所有基本块的控制流图都在同一层次，由统一的分发器函数控制程序执行流程。

符号执行技术是一种使用符号代替变量实际值进行代码执行分析的程序分析方法，通过在条件分支使用符号值列出不同路径的约束条件，最后对每条路径上的约束条件求解，得到执行该路径的输入符号对应的实际值。随着符号执行技术的发展，出现了抵抗符号执行技术的路径分支混淆策略。路径分支混淆的目的是阻止分支信息泄露，通过隐藏条件跳转指令，复杂化分支条件等方式保护分支信息，阻碍符号执行获取和求解约束条件的过程。路径分支信息由分支控制指令、分支条件、分支目标地址三部分组成，现有的路径分支混淆根据混淆变换对象也分为对分支控制方式、分支条件、分支目标地址的混淆。

#### 代码混淆的评估

Collberg 提出了评估混淆算法的三个指标：强度、弹性和开销，分别从混淆后程序的复杂度、抵抗反混淆攻击能力、额外开销等方面进行评估。

强度是用来描述混淆程序相比原程序增加的复杂度，Collberg 根据软件复杂性度量给出混淆强度的定义：

令 $T$ 是原程序 $P$ 到混淆程序 $P’$ 的转换，$E(P)$ 和 $E(P’)$ 分别表示表示原程序 $P$ 和混淆程序 $P’$ 的复杂度，则转换 T 的强度 $T_{pot}(P)$ 的定义如下：
$$
T_{pot}(P) = \frac{E(P')}{E(P)} - 1
$$
混淆程序的复杂程度描述了分析理解程序的难度，增加程序大小、引入新的类和方法、增加条件结构和循环结构等都会引起程序复杂度的增加。

弹性是指代码混淆算法抵抗反混淆技术的能力，攻击者可以利用反混淆技术减少混淆对分析理解代码的干扰。混淆的弹性取决于反混淆技术开发的难度和运行时的开销。使用无法恢复的单向混淆具有最强的混淆弹性，攻击者无法从混淆代码中恢复原程序信息。

开销是指混淆转换对程序的执行时间和空间上的影响。混淆转换使程序更复杂，因此必然给程序造成执行时间和占用空间大小上的影响。

路径分支混淆



## 算法设计与实现

## 实验结果

## 总结与展望

## 参考文献

[^1]:[AV-Test 恶意软件统计数据](https://www.av-test.org/en/statistics/malware/)

