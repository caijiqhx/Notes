# 二进制代码同源性

> [基于二进制代码同源性的恶意程序检测技术的研究与实现-北京邮电大学-黎恒](https://kns.cnki.net/KCMS/detail/detail.aspx?dbcode=CMFD&dbname=CMFD201902&filename=1019114091.nh&v=Mjk0MDM2RjdLNUd0SEZycEViUElSOGVYMUx1eFlTN0RoMVQzcVRyV00xRnJDVVI3cWZaT2R0RkNua1ZMek9WRjI=)

## 文章概要

通过对已有二进制代码同源性比对技术的分析和研究，设计并实现了二进制代码同源性比对系统。利用 IDA 对二进制程序进行反汇编，然后从程序的汇编代码中提取程序的各项特征并比较，最后计算程序之间的相似度，并根据该相似度判断程序之间的关系。

## 关键技术介绍

二进制代码同源性比对技术，主要包括基于文件字节流、汇编指令、结构化图像、基本块指纹和机器学习的同源性比对技术。

### 基于文件字节流的二进制代码比对技术

直接对二进制程序的字节流进行比较，不考虑程序本身具有的语义和逻辑结构。

只能比较出二进制文件字节改变很少的情况。在软件编译的过程中，软件源代码产生的微小的变化，可能会引起生成的软件文件字节发生很大的变化，并且相同的源代码在不同的环境下，通过不同的编译器生成的字节流也不一定完全相同。因此准确率低。

主要方法有两种：

- 计算程序签名比较，MD5 等。
- 计算软件和恶意程序样本字节流的最长公共子串，根据子串在恶意程序样本中的比重作为判断软件是否是恶意程序变体的依据。

### 基于汇编指令的二进制代码比对技术

先对二进制程序进行反汇编获取程序的汇编代码，然后分析反汇编得到的汇编代码。

该技术可检测软件源代码的少量变化，但无法避免因不同编译器和不同平台对程序比对造成的影响。指令流的比对无法检测程序结构的变化。

### 基于结构化图形的二进制代码比对技术

主要是针对二进制程序的逻辑结构进行比对。

将函数作为图的节点，函数调用关系作为边，形成程序的函数调用关系有向图。

在函数内部根据跳转指令将函数划分为不同的基本块。基本块作为图节点，基本块之间的跳转关系作为边，形成函数的控制流图。控制流图可视作函数调用图的子图。

二进制程序的比较可以视作对程序函数调用图和控制流程图的比较。

该技术先对程序进行反汇编，然后从汇编代码中提取特征构造调用图和流图。

### 基于基本块指纹的二进制代码比对技术

主要针对函数内部的基本块特征进行匹配。

基本块是指函数内的一段顺序指向的语句序列，每个基本块除了入口和出口外，不存在其他分支。

反汇编后提取基本块内部的跳转逻辑、代码序列和子函数名的指纹信息，然后对基本块的指纹信息进行签名，对基本块签名进行比较，以更细粒度的对比分析确定二进制程序之间的同源性。此方法得到的结果准确，但比较效率比较低。

### 小素数乘积法

为汇编指令的每一个助记符分配一个小素数，汇编代码转化为素数成绩，直接比较两个素数乘积的关系来确定恶意程序样本与待测程序汇编指令之间的关系。

可以避免因编译器指令重排对同源性比对结果的影响。

过程如下：

- 输入两个素数乘积 $P_1$ 和 $P_2$；

- 计算 $P_1$ 和 $P_2$ 含有的素数数量  $n_1$ 和 $n_2$；

- 从素数集合中去除一个素数 $p$，计算 $p$ 在 $P_1$ 和 $P_2$ 中的出现次数差 $d$；

- 计算素数总差异 $D$；

- 素数集合遍历结束后计算两个素数成绩的相似度：
  $$
  1 - \frac{D}{n_1 + n_2}
  $$
  

### Tarjan 算法

以有向图为输入，计算有向图的连通分量，以此给出顶点集的一个划分。

本系统中使用 Tarjan 算法计算控制流图的强连通分量。

## 系统设计与实现

系统分为五个模块：字节流比对、IDA 反汇编、特征提取、特征比对和相似度计算。

### 字节流比对模块

计算程序签名并比较。快速判断程序是否完全相同。

### IDA 反汇编

对程序进行反汇编，获取汇编代码。是后续处理的基础。

### 特征提取

特征提取模块需要选择合适的，具有代表性的二进制程序的多项特征，并提取出来作为特征匹配的对象。

- 常量特征：函数名、变量名等。
- 指令特征：程序汇编指令、基本块汇编代码、函数伪代码。
- 结构特征：函数调用图、控制流图。

将程序用图表示，函数作为子图，函数内部基本块作为子图的节点。在图的基础上提取函数和基本块层面的特征。两个程序的图之间匹配的部分代表二进制代码相似的部分，不匹配部分表示了程序代码之间的差异。

使用函数循环次数、函数控制流图的强连通分量以及 md_index 代替调用关系图和控制流图进行特征比对。md_index 是对函数控制流图进行计算得到的签名值。利用小素数乘积法求汇编代码和伪代码的签名。

库函数不作为函数个体参与特征比对，而是比对函数对库函数的调用。

### 特征比对

将提取的常量特征、指令特征和结构特征作为程序的指纹进行比对，生成恶意程序样本与待测程序之间的匹配函数对与不匹配函数对。

指令特征比对主要使用序列相似比较技术和小素数乘积法。

结构化特征比对主要是比对两个程序的函数循环次数、函数控制流图的连通分量和 md_index。

特征比对模块是以函数为基本单元，维护匹配函数队列和未匹配队列。

### 相似度计算

接收特征比对模块生成两个程序的匹配函数对，以此计算函数相似度和程序相似度。

利用序列相似度比较算法计算汇编代码、伪代码的相似度。计算伪代码签名以及 md_index 的相似度。最后

综合考虑函数指令特征和结构特征。对于相似度低的函数视作未匹配函数对。