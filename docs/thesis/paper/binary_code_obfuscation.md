# 二进制代码混淆

> [基于二进制代码混淆的软件保护研究-电子科技大学-吴适](https://kns.cnki.net/KCMS/detail/detail.aspx?dbcode=CMFD&dbname=CMFD201401&filename=1013331373.nh&v=MjMwNjg3RGgxVDNxVHJXTTFGckNVUjdxZlpPZHFGQ25tVzc3TFZGMjZIYkM3SDlMTHJKRWJQSVI4ZVgxTHV4WVM=)

## 文章概要

本文以二进制程序软件保护为目的，重点对二进制代码混淆算法进行研究，分析了二进制代码混淆算法实现的关键技术。

## 相关技术

### 二进制分析技术

- PE 文件格式，DOS 头部、PE 头、区块表、区块等。
- 静态分析
  - 反汇编
    - 线性扫描，简单地扫描整个代码节并反汇编指令，无法处理代码中嵌入的数据。
    - 递归遍历，从程序入口点开始，沿着程序的控制流反汇编，无法识别出所有控制转移指令的目标，导致反汇编不完整。
- 动态分析，操作复杂，人工，反调试。
- 混合分析
- 其他分析技术，程序切片、控制流分析、数据流分析。

### 针对二进制程序的攻击方法

- 逆向工程，`机器码--反汇编-->汇编代码---反编译->高级语言`
- 软件篡改
  - 静态防篡改，加壳、代码混淆。
  - 动态防篡改，程序完整性判断。
- 代码注入，缓冲区溢出。

### 代码混淆相关技术

#### 代码混淆的概念

Collberg 最先给出代码混淆的概念。

原程序 $P$ 经过一个转换 $T$ 后称为目标程序 $P’$，在转换过程中，原程序 $P$ 和目标程序 $P'$ 语义上是等价的，满足以下条件的转换称程序 $P$ 到目标程序 $P'$ 的转换是混淆转换：

1. 原程序 $P$ 出现错误无法终止时或因为错误而终止时，目标程序 $P'$ 可以终止也可以不终止；
2. 否则，目标程序 $P'$ 必须终止，且 $P'$ 的输出结果必须和原程序 $P$ 的结果相同。

#### 代码混淆的分类

Collberg, Chenxi Wang 和 Wroblewski 提出了不同的分类方式。

##### Collberg 的分类方法

- 布局混淆，或称为词法结构混淆，是指在不影响指令功能的情况下改变或删除中间代码或源代码中的有用信息。
  - 删除注释、删除调试信息。
  - 替换变量名等。
- 控制流混淆，不改变整体功能性的情况下，改变或隐藏原程序的控制流。
  1. 控制流聚合，将逻辑上相关的计算分开或者将不相关的计算合并；
  2. 控制排序，基于表达式、基本块或方法的局部性原理，随机化它们在原程序中的位置；
  3. 计算混淆，通过增加、删除控制流抽象达到隐藏实际控制流的目的。
  - 不透明结构，是指在一个程序中的某一点 $p$ 的变量 $V$ 或预测 $P$，其计算结果在混淆前是可知的，在混淆后难以确定。
  - 常见的控制流混淆
    - 插入不透明预测：混淆前，在原程序中的某一点 $p$ 是一个绝对跳转，混淆后，$p$ 点处转换为一个条件跳转，但该条件跳转运行时始终进入某个固定分支。
    - 控制流平展：混淆前，根据程序中基本块的跳转指令，能够构建层次清晰的控制流图，经过控制流平展混淆后，所有基本块在控制流图中都处于同一层次，基本块之间的转移通过使用一个统一的函数来控制。

