# 第 1 章：基本知识

## 1.2 文本字符

### ASCII 码

- `0x00~0x7F` 固定
- `0x80~0xFF` 不固定，有 ANSI、Symbol、OEM 等字符集

### Unicode

ASCII 的扩展，Windows 中用 2 字节进行编码，成为宽字符集。

ASCII 码被扩充为 16 位，高位扩充零。

Intel 中存放按 Little-endian 顺序。

### 字节存储顺序

- Big-endian: 高位字节存入低地址，低位字节存入高地址。
- Little-endian: 低位字节存入低地址，高位字节存入高地址。

一般来说，x86 系列 CPU 都是 Little-endian，PowerPC 通常是 Big-endian。网络协议采用 Big-endian 字节序。

## 1.3 Windows 操作系统

### WOW64

Windows-on-Windows 64-bit 是 64 位 Windows 操作系统的子系统，可以使大多数 32 位应用程序在不进行修改的情况下运行在 64 位操作系统上。

Windows 的 64 位系统文件都放在 Windows\System32 文件夹下，包含原生的 64 位映像文件。为兼容 32 位操作系统，增加了 Windows\WOW64 文件夹，其中存储了 32 位系统文件。

64 位应用程序会加载 System32 目录下 64 位的 kernel32.dll、user32.dll 和 ntdll.dll。当 32 位应用程序加载时，WOW64 建立 32 位 ntdll.dll 所要求的启动环境，将 CPU 模式切换至 32 位，并开始执行 32 位加载器。WOW64 会对 32 位 ntdll.dll 的调用重定向 ntdll.dll（64位），而不是发出原生的 32 位系统调用指令。WOW64 转换到原生的 64 位模式，捕获与系统调用有关的参数，发出对应的原生 64 位系统调用。系统调用返回时，WOW64 在返回 32 位模式之前将所有的输出参数转换成 32 位。

WOW64 既不支持 16 位应用程序的执行（32 位 Windows 支持），也不支持加载 32 位内核模式的设备驱动程序。WOW64 进程只能架子啊 32 位的 DLL，不能加载原生的 64 位DLL。类似的，原生的 64 位进程不能加载 32 位的 DLL。

### Windows 消息机制

Windows 消息提供在应用程序之间、应用程序与 Windows 系统之间进行通信的手段。应用程序想要实现的功能由消息触发，通过对消息的响应和处理完成。

当一个事件发生时，Windows 先将输入的消息放入系统消息队列，再将输入的消息复制到相应的应用程序队列中，应用程序中的消息循环在它的消息队列中检索每个消息并发送给相应的窗口函数。消息具有非抢先性。

### 虚拟内存

虚拟内存的实现方法和过程如下：

- 应用程序启动时，操作系统创建一个进程，并给该进程分配 2GB 的虚拟地址（不是内存，只是地址）。
- 虚拟内存管理器将应用程序的代码映射到那个应用程序的虚拟地址中的某个位置，并把当前需要的代码读入物理地址。
- 如果使用 DLL，DLL 也会被映射到进程的虚拟地址空间中，在需要的时候才会被读入物理内存。
- 其他项目（数据、堆栈等）的空间是从物理内存中分配的，并被映射到虚拟地址空间中。
- 应用程序通过使用其虚拟地址空间中的地址开始执行。然后，虚拟内存管理器把每次内存访问映射到物理地址。